<!DOCTYPE html>
<html>
    <head>
        <script>

            class Interpreter {
                
                constructor() {
                    this.registers = {}         // Variables that are stored and/or manipulated
                    this.blocks_list = []       // List of code instruction blocks. Separated by line number
                    this.instructions = []
                }

                fetch() { // Pull instruction from instruction components
                    this.blocks_list = document.getElementById("instructions")
                        .innerHTML
                        .split("\n")        // Each code instruction needs to be on it's own line
                        .map(x => x.trim()) // Trim white space from each line
                        .filter(x => {
                            return x.length > 0 // Make sure empty strings aren't added to list
                        })
                    console.log("End of fetch:")
                    console.log(this.blocks_list)
                    
                }
                decode() {  // Instruction should be a component with attributes that represent registers
                            // and extract the values from them as well as the function being performed
                            // Load values into registers

                    // Split each code line up into keywords and values by white space
                    var kw_vals = this.blocks_list.map( x => {
                        var arr = x.split(/\s/)     
                        return arr
                    })

                    for (let i in kw_vals) {        // Go through each line given in the problem
                        var keyword=kw_vals[i][0]   // Keyword = first word on a line
                        var line = kw_vals[i]
                        var instruction = {}

                        // Trying to check if register has a variable already exists and execute accordingly
                        for (var reg in this.registers) {  
                            if (this.registers.hasOwnProperty(keyword)) {
                                keyword = "variable"
                                break
                            }
                        }
                        switch (keyword) {
                        
                            case "int":     //  LOAD WORD: Copy from memory to register
                                            // This only works for declarative statements STRICTLY as follows: int a = 5
                                var line = kw_vals[i]
                                instruction = {
                                    func: "lw",       // func should represent the function given in the instruction
                                    var1: line[(line.indexOf("=")-1)],  // variable name being stored to register
                                    value: line[line.length-1]          // value being stored to register
                                }
                                break;
                            case "variable":
                                if (!isNumeric(line[line.length-1]) ) { // check if we need to use add or addi function
                                    line = kw_vals[i]
                                    instruction = {
                                        func: "add",        // func should represent the function given in the instruction
                                        reg_val: line[0],   // register that will be added to
                                        var1: line[(line.indexOf("+")-1)],  // operand 1
                                        var2: line[line.length-1]           // operand 2
                                    }
                                }   
                                else {
                                    line = kw_vals[i]
                                    instruction = {
                                        func: "addi",        // func should represent the function given in the instruction
                                        reg_val: line[0],   // register that will be added to
                                        var1: line[(line.indexOf("+")-1)],  // operand 1
                                        var2: line[line.length-1]           // operand 2 (Number)
                                    }
                                    
                                }   
                                break;
                        }
                        this.instructions.push(instruction)
                        this.execute(instruction)
                    }
                    console.log("End of decoded:")
                    console.log(this.instructions)
                    
                }

                // Instructions execute after each instruction is decoded, so it reads and executes code from top to bottom.
                execute(instruction) {
                    let key = instruction
                    if (key.func == "lw") {     // Loading value to registers
                            this.registers[key.var1] = key.value
                        }
                    else if (key.func == "add") {   // used for adding two integer variables 
                        let register_name = key.reg_val
                        let val1 = this.registers[key.var1]
                        let val2 = this.registers[key.var2]
                        let new_val = add(val1, val2)
                        this.registers[register_name] = new_val
                        var p = document.createElement("P")
                        p.innerText = register_name + " = " +this.registers[register_name] 
                        document.body.append(p)
                    }
                    else if (key.func == "addi") { // adding variable with a constant and assigning it to variable
                        let register_name = key.reg_val
                        let val1 = this.registers[key.var1]
                        let val2 = key.var2
                        let new_val = addi(val1, val2)                            
                        this.registers[register_name] = new_val
                        var p = document.createElement("P")
                        p.innerText = register_name + " = " +this.registers[register_name]
                        document.body.append(p)
                    }
                }
                
            }

            let interpreter = new Interpreter();

        </script>
    </head>
    <body>
        
        <div>
            <h1>Instructions: </h1>
            <div>
                <p id="instructions">
                    int abc = 0
                    int i = 7 
                    i = i + 50
                    int j = 5
                    i = i + j
                    abc = i + j

                </p>
                <!-- Instructions that work -->
                    <!-- int i = 4
                    int j = 5
                    i = i + j -->
                <button onclick="run()">run</button>
            </div>
        </div>
        <script>
            function run() {
                interpreter.fetch()
                interpreter.decode()
            }
            function addi(val1, val2) {
                return parseInt(val1) + parseInt(val2)
            }
            function add(val1, val2) {
                return parseInt(val1) + parseInt(val2)
            }
            function isNumeric(n) {
                return !isNaN(parseFloat(n)) && isFinite(n);
}

        </script>
    </body>
</html>