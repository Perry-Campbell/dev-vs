<!DOCTYPE html>
<html>
    <head>
        <script>
            class Instruction {

                constructor(keyword, line) {    // Keyword represents the instruction being performed on
                    this.keyword = keyword
                    this.line = line
                }
            }
            class Interpreter {
                
                constructor() {
                    this.registers = {}         // Variables that are stored and/or manipulated
                    this.blocks_list = []       // List of code instruction blocks. Separated by line number
                
                }

                fetch() { // Pull instruction from instruction components
                    this.blocks_list = document.getElementById("instructions")
                        .innerHTML
                        .split("\n")        // Each code instruction needs to be on it's own line
                        .map(x => x.trim()) // Trim white space from each line
                        .filter(x => {
                            return x.length > 0 // Make sure empty strings aren't added to list
                        })
                    console.log("End of fetch:")
                    console.log(this.blocks_list)
                    
                }
                decode() {  // Instruction should be a component with attributes that represent registers
                            // and extract the values from them as well as the function being performed
                            // Load values into registers

                    // Split each code line up into keywords and values by white space
                    var kw_vals = this.blocks_list.map( x => {
                        var arr = x.split(/\s/)     
                        return arr
                    })

                    var decoded = []    // Instructions added after they are decoded

                    for (let i in kw_vals) {        // Go through each line given in the problem
                        var keyword=kw_vals[i][0]   // Keyword = first word on a line
                        var line = kw_vals[i]
                        switch (keyword) {
                        
                            case "int":     //  LOAD WORD: Copy from memory to register
                                            // This only works for declarative statements STRICTLY as follows: int a = 5
                                var line = kw_vals[i]
                                var instruction = {
                                    func: "lw",       // func should represent the function given in the instruction
                                    var1: line[(line.indexOf("=")-1)],  // variable name being stored to register
                                    value: line[line.length-1]          // value being stored to register
                                }
                        
                                decoded.push(instruction)
                                break;
                            case 'i':
                                if (!isNumeric([line.length-1])) { // check if we need to use add or addi function
                                    line = kw_vals[i]
                                    var instruction = {
                                        func: "add",        // func should represent the function given in the instruction
                                        reg_val: line[0],   // register that will be added to
                                        var1: line[(line.indexOf("+")-1)],  // operand 1
                                        var2: line[line.length-1]           // operand 2
                                    }
                                    decoded.push(instruction)
                                }   
                                else {
                                    line = kw_vals[i]
                                    var instruction = {
                                        func: "addi",        // func should represent the function given in the instruction
                                        reg_val: line[0],   // register that will be added to
                                        var1: line[(line.indexOf("+")-1)],  // operand 1
                                        var2: line[line.length-1]           // operand 2 (Number)
                                    }
                                    decoded.push(instruction)
                                }   
                                break;

                        }
                    }
                    this.instructions = decoded


                    console.log("End of decoded:")
                    console.log(this.registers)
                    
                }
                execute() {

                    for (var key in this.registers ) {  // Reading values from registers
                        if (this.registers.hasOwnProperty(key)) {
                            console.log(key + " -> " + this.registers[key]);
                        }
                    }
                    // lw a i 4
                    for (let reg in this.instructions) {    
                        let key = this.instructions[reg]
                        if (key.func == "lw") {     // Loading value to registers
                            this.registers[key.var1] = key.value
                        }
                        else if (key.func == "add") {   // used for adding two integer variables 
                            let register_name = key.reg_val
                            let val1 = this.registers[key.var1]
                            let val2 = this.registers[key.var2]
                            let new_val = add(val1, val2)
                            this.registers[register_name] = new_val
                            var p = document.createElement("P")
                            p.innerText = register_name + " = " +this.registers[register_name]
                            document.body.append(p)
                        }
                        else if (key.func == "addi") { // adding variable with a constant and assigning it to variable
                            let register_name = key.reg_val
                            let val1 = this.registers[key.var1]
                            let val2 = key.var2
                            let new_val = addi(val1, val2)
                            this.registers[register_name] = new_val
                            var p = document.createElement("P")
                            p.innerText = register_name + " = " +this.registers[register_name]
                            document.body.append(p)
                        }
                    }

                    console.log("End of execute:")
                    console.log(this.registers)

                }
            }

            let interpreter = new Interpreter();

        </script>
    </head>
    <body>
        
        <div>
            <h1>Instructions: </h1>
            <div>
                <p id="instructions">
                    int i = 7
                    i = i + 50
                    int j = 5
                    i = i + j
                </p>
                <!-- Instructions that work -->
                    <!-- int i = 4
                    int j = 5
                    i = i + j -->
                <button onclick="run()">run</button>
            </div>
        </div>
        <script>
            function run() {
                interpreter.fetch()
                interpreter.decode()
                interpreter.execute()
            }
            function addi(val1, val2) {
                console.log(val1)
                console.log(val2)
                return parseInt(val1) + parseInt(val2)
            }
            function add(val1, val2) {
                return parseInt(val1) + parseInt(val2)
            }
            function isNumeric(n) {
                return !isNaN(parseFloat(n)) && isFinite(n);
}

        </script>
    </body>
</html>